<!DOCTYPE html>
<head>
   <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.5/leaflet.css" />
   <script src="http://cdn.leafletjs.com/leaflet-0.5/leaflet.js"></script>
   <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
   <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
   <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>
   
</head>
<body>


        <div class="container-responsive">
                <div class="row">
                  <div class="col-6 float-left-responsive">
                        <div class="position-absolute top-0 start-0 col d-flex flex-column float-left-responsive"> 
                                <span class="border border-light border-5 rounded">
                                        <div class="col-sm-6 col-md-6 col-lg-6-responsive" id="map" style="width: 800px; height: 780px"></div>         
                                </span>
                        </div>
                  </div>
                        <div class="col-6">
                                <div class="card row" style="width: 30rem;">
                                <div class="card-body">
                                <h5 class="card-title">Instrucciones</h5>
                                
                                 <p  class="card-text">Para utilizar el calculo de area de una zona determinada, primero coloque marcadores en el lado 
                                        derecho del mapa haciendo click sobre el y envie los datos, posteriormente haga lo mismo con el lado izquierdo y se determinara el area de la region seleccionada
                                 </p>
                                </div>
                        </div>
                
                        <br>
                        <div class="col-6">
                                <div class="card row" style="width: 18rem;">
                                        <div class="card-body">
                                        <h5 class="card-title">El area total de chile</h5>
                                        
                                         <p class="card-text">El area resultante es:</p>
                                         <h6 id="area">61912.3215 Km2</h6>
                                </div>
                                
                        </div>
                        <br>
                        <div class="col-6">
                                <div class="card row" style="width: 18rem;">
                                        <div class="card-body">
                                        <h5 class="card-title">Marcadores</h5>
                                        
                                         <p  class="card-text">Para definir el area, se usaron un total de: </p>
                                         <h6 id="mark">3622</h6>
                                </div>
                        </div>
                        <br>
                        <div class="col-6">
                                <div class="card row" style="width: 18rem;">
                                        <div class="card-body">
                                        <h5 class="card-title">Area retornada</h5>
                                        <div class="text-center"> 
                                                <button class="col-6 align-self-end btn btn btn-outline-success" onclick="enviar()">Enviar</button>
                                        </div>                               
                                         <p class="card-text">Area del contorno derecho:</p>
                                         <h6 id="der"></h6>
                                         <p class="card-text">Area del contorno izquierdo:</p>
                                         <h6 id="izq"></h6>
                                         <p class="card-text">Area de la region seleccionada:</p>
                                         <h5 id="reg"></h5>

                                 
                                </div>
                                
                        </div>
                       
                </div>
        </div>


<script>
var l_izq=[]
var l_der=[]
$.getJSON("http://127.0.0.1:5000/GetData", function(data) {Crear_poly_line(data["1"],data['2'])});


function Crear_poly_line(izq, der){
var poly_line_derecha = L.polyline(
                   der,
                {"bubblingMouseEvents": true, "color": "red", "dashArray": null, "dashOffset": null, "fill": false, "fillColor": "red", "fillOpacity": 0.2, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "noClip": false, "opacity": 0.8, "smoothFactor": 1.0, "stroke": true, "weight": 2}
            ).addTo(map);

            var poly_line_izquierda = L.polyline(
                
                izq,
                {"bubblingMouseEvents": true, "color": "red", "dashArray": null, "dashOffset": null, "fill": false, "fillColor": "red", "fillOpacity": 0.2, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "noClip": false, "opacity": 0.8, "smoothFactor": 1.0, "stroke": true, "weight": 2}
        ).addTo(map);
}

const map = L.map(
                "map",
                {
                    center: [-38.737899, -72.597568],
                    crs: L.CRS.EPSG3857,
                    zoom: 8,
                    zoomControl: true,
                    preferCanvas: false,
                }
            );
            const tile_layer = L.tileLayer(
                "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",
                {"attribution": "Data by \u0026copy; \u003ca href=\"http://openstreetmap.org\"\u003eOpenStreetMap\u003c/a\u003e, under \u003ca href=\"http://www.openstreetmap.org/copyright\"\u003eODbL\u003c/a\u003e.", "detectRetina": false, "maxNativeZoom": 18, "maxZoom": 18, "minZoom": 0, "noWrap": false, "opacity": 1, "subdomains": "abc", "tms": false}
            ).addTo(map);

            var c0 = L.polyline([[-17.498407523582113, -71.3671875],[-17.498407523582113, -69.46848928928375],[-17.498407523582113, -67.1044921875]],
               {"bubblingMouseEvents": true, "color": "red", "dashArray": null, "dashOffset": null, "fill": false, "fillColor": "red", "fillOpacity": 0.2, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "noClip": false, "opacity": 0.8, "smoothFactor": 1.0, "stroke": true, "weight": 2}
          ).addTo(map);

var c1 = L.polyline([[-19.22947341397525, -70.2853775024414],[-19.22947341397525, -68.648134]],
               {"bubblingMouseEvents": true, "color": "red", "dashArray": null, "dashOffset": null, "fill": false, "fillColor": "red", "fillOpacity": 0.2, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "noClip": false, "opacity": 0.8, "smoothFactor": 1.0, "stroke": true, "weight": 2}
          ).addTo(map);

var c2 = L.polyline([[-21.430000269278064, -70.05877375602722],[-21.430000269278064, -68.179549]],
                {"bubblingMouseEvents": true, "color": "red", "dashArray": null, "dashOffset": null, "fill": false, "fillColor": "red", "fillOpacity": 0.2, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "noClip": false, "opacity": 0.8, "smoothFactor": 1.0, "stroke": true, "weight": 2}
          ).addTo(map);

var c3 = L.polyline([[-26.06129354587994, -70.65848350524902],[-26.06129354587994, -68.40532064437866]],
        {"bubblingMouseEvents": true, "color": "red", "dashArray": null, "dashOffset": null, "fill": false, "fillColor": "red", "fillOpacity": 0.2, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "noClip": false, "opacity": 0.8, "smoothFactor": 1.0, "stroke": true, "weight": 2}
        ).addTo(map);

var c4 = L.polyline([[-29.184758344199235, -71.49818122386932],[-29.184758344199235, -69.92239952087402]],
        {"bubblingMouseEvents": true, "color": "red", "dashArray": null, "dashOffset": null, "fill": false, "fillColor": "red", "fillOpacity": 0.2, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "noClip": false, "opacity": 0.8, "smoothFactor": 1.0, "stroke": true, "weight": 2}
        ).addTo(map);

var c5 = L.polyline([[-32.17641161182748, -71.53634905815125],[-32.17641161182748, -70.323486328125]],
        {"bubblingMouseEvents": true, "color": "red", "dashArray": null, "dashOffset": null, "fill": false, "fillColor": "red", "fillOpacity": 0.2, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "noClip": false, "opacity": 0.8, "smoothFactor": 1.0, "stroke": true, "weight": 2}
        ).addTo(map);

var c6 = L.polyline([[-34.68643988069558, -72.05597877502441],[-34.68643988069558, -70.25636672973633]],
        {"bubblingMouseEvents": true, "color": "red", "dashArray": null, "dashOffset": null, "fill": false, "fillColor": "red", "fillOpacity": 0.2, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "noClip": false, "opacity": 0.8, "smoothFactor": 1.0, "stroke": true, "weight": 2}
        ).addTo(map);

var c7 = L.polyline([[-36.01363869000407, -72.7787697315216],[-36.01363869000407, -70.57342529296875]],
        {"bubblingMouseEvents": true, "color": "red", "dashArray": null, "dashOffset": null, "fill": false, "fillColor": "red", "fillOpacity": 0.2, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "noClip": false, "opacity": 0.8, "smoothFactor": 1.0, "stroke": true, "weight": 2}
        ).addTo(map);

var c8 = L.polyline([[-37.06832751759658, -71.09519004821777],[-37.06832751759658, -73.14010620117188]],
        {"bubblingMouseEvents": true, "color": "red", "dashArray": null, "dashOffset": null, "fill": false, "fillColor": "red", "fillOpacity": 0.2, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "noClip": false, "opacity": 0.8, "smoothFactor": 1.0, "stroke": true, "weight": 2}
        ).addTo(map);

var c9 = L.polyline([[-38.174242377450035, -73.45699310302734],[-38.174242377450035, -71.015625]],
        {"bubblingMouseEvents": true, "color": "red", "dashArray": null, "dashOffset": null, "fill": false, "fillColor": "red", "fillOpacity": 0.2, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "noClip": false, "opacity": 0.8, "smoothFactor": 1.0, "stroke": true, "weight": 2}
        ).addTo(map);

var c10 = L.polyline([[-39.40694476218913, -73.22107672691345],[-39.40694476218913, -71.46297454833984]],
        {"bubblingMouseEvents": true, "color": "red", "dashArray": null, "dashOffset": null, "fill": false, "fillColor": "red", "fillOpacity": 0.2, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "noClip": false, "opacity": 0.8, "smoothFactor": 1.0, "stroke": true, "weight": 2}
        ).addTo(map);

var c11 = L.polyline([[-40.53157816907408, -73.71542930603027],[-40.53157816907408, -71.86981201171875]],
        {"bubblingMouseEvents": true, "color": "red", "dashArray": null, "dashOffset": null, "fill": false, "fillColor": "red", "fillOpacity": 0.2, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "noClip": false, "opacity": 0.8, "smoothFactor": 1.0, "stroke": true, "weight": 2}
        ).addTo(map);
        //
var c12 = L.polyline([[-43.7869583731156, -71.74896240234375],[-43.7869583731156, -74.82981201171875]],
        {"bubblingMouseEvents": true, "color": "red", "dashArray": null, "dashOffset": null, "fill": false, "fillColor": "red", "fillOpacity": 0.2, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "noClip": false, "opacity": 0.8, "smoothFactor": 1.0, "stroke": true, "weight": 2}
        ).addTo(map);
var c13 = L.polyline([[-48.8524043595297, -72.61911392211914],[-48.8524043595297,  -75.69951553344727]],
        {"bubblingMouseEvents": true, "color": "red", "dashArray": null, "dashOffset": null, "fill": false, "fillColor": "red", "fillOpacity": 0.2, "fillRule": "evenodd", "lineCap": "round", "lineJoin": "round", "noClip": false, "opacity": 0.8, "smoothFactor": 1.0, "stroke": true, "weight": 2}
        ).addTo(map);
var marker_1 = L.marker([-17.5, -80]);
marker_1.bindPopup("limite norte izquierda");
map.addLayer(marker_1)
/////////
var marker_6 = L.marker([-17.5, -60]);
marker_6.bindPopup("limite norte derecha");
map.addLayer(marker_6)
/////////
var marker_2 = L.marker([-56, -80-7.191961644623876]);
marker_2.bindPopup("nodo izquierda bajo");
map.addLayer(marker_2)
/////////
var marker_5 = L.marker([-56, -60+7.19196164623876]);
marker_5.bindPopup("nodo derecha bajo");
map.addLayer(marker_5)

coord =[];
reg=[];
cont=0
geojson={}
function newMarker(e){
    var new_mark = L.marker().setLatLng(e.latlng).addTo(map);
    new_mark.dragging.enable();
    console.log(new_mark)
    coord.push( { 
        "coordenadas"    : [new_mark._latlng.lat, new_mark._latlng.lng]
    })
    reg.push( { 
        "region"    : 0
    })
    new_mark.on('dblclick', function(e){
        console.log(e.target._latlng)})
    var lat = e.latlng.lat.toFixed(4),
       lng = e.latlng.lng.toFixed(4);
    new_mark.bindPopup("nuevo marcador");
};
map.on('click', newMarker)
cont=0
der=0
function enviar(){
    geojson.coordenadas = coord
    geojson.regiones = reg
    coord =[]
    reg=[]
    send = JSON.stringify(geojson);
    $.ajax({
            url:"/SendData",
            type:"POST",
            contentType: "application/json",
            data: JSON.stringify(send),
            success: function(response){
                console.log(response)
                if (cont%2==0){
                var aread = document.getElementById('der');
                aread.innerHTML = response+" Km2";
                der = ~~response
        }else{

                var areai = document.getElementById('izq');
                areai.innerHTML = response+" Km2";
                var reg = document.getElementById('reg');
                var area2 = (~~response);
                console.log(der-area2)
                reg.innerHTML = der-area2+" Km2";
        }
        cont=cont+1;
            }
        });
        
    console.log("Enviado")

        }

</script>

</body>